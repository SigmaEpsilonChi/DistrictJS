<!DOCTYPE html>
<style>
html{
    width:100%;
    height:100%;
    margin: 0;
    padding: 0;
}
body{
    width:100%;
    height:100%;
    background-color:#FFFFFF;
    overflow: hidden;
    margin: 0;
    padding: 0;
}
canvas {
    display: block;
    touch-action: none;
}
</style>
    <html>
    <head>
        <title>District</title>
        <script language="javascript" src="./js/mover.js" type="text/javascript"></script>
        <script language="javascript" src="./js/rep.js" type="text/javascript"></script>
        <script language="javascript" src="./js/view.js" type="text/javascript"></script>
        <script language="javascript" src="./js/util.js" type="text/javascript"></script>
        <script language="javascript" src="./js/port.js" type="text/javascript"></script>
        <script language="javascript" src="./js/menu.js" type="text/javascript"></script>
        <script language="javascript" src="./js/post.js" type="text/javascript"></script>
        <script language="javascript" src="./js/pawn.js" type="text/javascript"></script>
        <script language="javascript" src="./js/fence.js" type="text/javascript"></script>
        <script language="javascript" src="./js/board.js" type="text/javascript"></script>
        <script language="javascript" src="./js/group.js" type="text/javascript"></script>
        <script language="javascript" src="./js/stage.js" type="text/javascript"></script>
        <script language="javascript" src="./js/camera.js" type="text/javascript"></script>
        <script language="javascript" src="./js/button.js" type="text/javascript"></script>
        <script language="javascript" src="./js/balance.js" type="text/javascript"></script>

        <link rel="icon" type="image/png" href="/favicon.png"/>
    </head>
    <body>
        <canvas width="768" height="768" id="gameCanvas">Canvas tag not supported</canvas>
        <img id="baddistricts" width="0" height="0" src="./res/baddistricts.png">

        <script type='text/javascript'>
            var endStageImage = document.getElementById("baddistricts");

            var canvas = document.getElementById("gameCanvas");;
            var context = canvas.getContext("2d");

            var CANVAS_WIDTH = canvas.offsetWidth;
            var CANVAS_HEIGHT = canvas.offsetHeight;

            canvas.addEventListener("mousedown", onMouseDown, false);
            canvas.addEventListener("mouseup", onMouseUp, false);
            canvas.addEventListener("mousemove", onMouseMove, false);

            canvas.addEventListener("touchstart", onTouchStart, false);
            canvas.addEventListener("touchend", onTouchEnd, false);
            canvas.addEventListener("touchcancel", onTouchCancel, false);
            canvas.addEventListener("touchmove", onTouchMove, false);

            var mouseListeners = [];
            var updateListeners = [];

            var sizes = {
                pawnRadius: 1,
                postRadius: .3,
                fenceWidth: .3,
                counterSize: .025,
                counterGap: .005,
            }

            var colors = {
                teamNeutral: '#808080',
                groupNeutral: 'rgb(192, 192, 192)',

                teams: [
                    'rgb(208, 32, 32)',
                    'rgb(32, 32, 208)',
                    'rgb(128, 128, 128)',
                    'rgb(16, 16, 16)',
                ],

                teamsLight: [
                    'rgb(224, 128, 128)',
                    'rgb(128, 128, 224)',
                    'rgb(192, 192, 192)',
                    'rgb(32, 32, 32)',
                ],

                teamsDark: [
                    'rgb(192, 16, 16)',
                    'rgb(16, 16, 192)',
                    'rgb(64, 64, 64)',
                    'rgb(0, 0, 0)',
                ],

                post: {
                    base: '#E6E6E6',
                    touch: '#CCCCCC',
                },

                fence: {
                    base: '#202020',
                    drag: '#606060',
                },

                menu: {
                    base: '#18F2F2',
                    touch: '#F2BC18',
                    click: '#CCCCCC',
                    prompt: '#404040',
                    disabled: '#808080',
                },

                balance: {
                    arm: '#404040',
                    pan: '#202020',
                }
            }

            var strings = {
                center: "center",
            }

            var borderSize = 1;

            var mousePoint = {x: 0, y: 0}
            var mousePointWorld = {x: 0, y: 0}

            var time = 0;
            var deltaTime;
            var drawTime = 0;

            var click = false;
            var dirty = false;

            var view = View();
            var menu = Menu();
            var port = Port();
            var camera = Camera();

            var board;
            var defaultBoardSpec = {
                goalTeam: 0,
                goalScore: 0,
                groupCount: 4,
                mutable: true,
                layout: [
                    [0, 0, 1, 1],
                    [0, 0, 1, 1],
                    [0, 0, 1, 1],
                    [0, 0, 1, 1],
                ],
            }
            var sandbox = false;

            var completionCallback;
            window.setCompletionCallback = function(callback){
                console.log("Completion callback has been provided!");
                completionCallback = callback;
            }

            function start() {
                var FPS = 60;
                deltaTime = 1/FPS;
                setInterval(function() {
                  update();
                }, 1000/FPS);

                var queryBoard = getQueryBoard();
                if (queryBoard != null) {
                    console.log("Loading queryboard");
                    board = queryBoard;
                }
                else {
                    board = Board(defaultBoardSpec);
                    board.setMutable(true);
                }

                board.setActive(true);

                camera.position = board.position;
                camera.fov = board.getFov();

                update();

                window.requestAnimationFrame(step);
            }

            function step(timestamp) {
                if (dirty) {
                    draw();
                    dirty = false;
                }
                window.requestAnimationFrame(step);
            }

            function update() {
                time = time+deltaTime;
                menu.update();
                for (var i = 0; i < updateListeners.length; i++) {
                    updateListeners[i].update();
                }
                board.update();
                dirty = true;
            }

            function draw() {
                clear();
                board.draw();
                menu.draw();
                //drawBorder();
            }

            function clear(){
                //context.clearRect(borderSize, borderSize, CANVAS_WIDTH-borderSize*2, CANVAS_HEIGHT-borderSize*2);
                context.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            }

            function drawBorder(){
                context.beginPath();
                context.rect(borderSize/2, borderSize/2, CANVAS_WIDTH-borderSize, CANVAS_HEIGHT-borderSize);
                context.lineWidth = borderSize;
                context.strokeStyle = '#000000';
                context.stroke();
            }

            function onMouseDown(event){
                click = true;

                mousePoint = getMousePos(canvas, event);
                mousePointWorld = camera.transformPoint(mousePoint);

                for (var i = 0; i < mouseListeners.length; i++) {
                    mouseListeners[i].onMouseDown(mousePoint);
                }

                board.onMouseDown(mousePoint);
            }

            function onMouseUp(event){
                click = false;

                for (var i = 0; i < mouseListeners.length; i++) {
                    mouseListeners[i].onMouseUp(mousePoint);
                }

                board.onMouseUp(mousePoint);
            }

            function onMouseMove(event){
                mousePoint = getMousePos(canvas, event);
                mousePointWorld = camera.transformPoint(mousePoint);

                for (var i = 0; i < mouseListeners.length; i++) {
                    mouseListeners[i].onMouseMove(mousePoint);
                }

                board.onMouseMove(mousePoint);
            }

            function onTouchStart(event){
                var touch = event.touches[0];
                var mouseEvent = new MouseEvent("mousedown", {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
                //onMouseDown(convertTouches(event));
            }

            function onTouchEnd(event){
                var touch = event.touches[0];
                var mouseEvent = new MouseEvent("mouseup");
                canvas.dispatchEvent(mouseEvent);
                //onMouseUp(convertTouches(event));
            }

            function onTouchMove(event){
                var touch = event.touches[0];
                var mouseEvent = new MouseEvent("mousemove", {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
                //onMouseMove(convertTouches(event));
            }

            function onTouchCancel(event){
                //onMouseUp(convertTouches(event));
            }

            function getMousePos(canvas, event){
                var rect = canvas.getBoundingClientRect();
                return {
                    x: event.clientX - rect.left,
                    y: event.clientY - rect.top
                };
            }

            function convertTouches(event){
                var touches = event.touches;
                if (touches.length > 0) {
                    event.clientX = touches[0].clientX;
                    event.clientY = touches[0].clientY;
                }
            }

            function getQueryString(field, url){
                var href = url ? url : window.location.href;
                var reg = new RegExp( '[?&]' + field + '=([^&#]*)', 'i' );
                var string = reg.exec(href);
                return string ? string[1] : null;
            }

            function getQueryBoard(){
                var xCount = parseInt(getQueryString("x"));
                var yCount = parseInt(getQueryString("y"));
                
                var score = parseInt(getQueryString("s"));
                var team = parseInt(getQueryString("t"));

                var groups = parseInt(getQueryString("g"));
                var reps = parseInt(getQueryString("r"));

                var pawns = getQueryString("p");

                if (isNaN(xCount) || isNaN(yCount) || isNaN(score) || isNaN(team) || isNaN(groups) || isNaN(reps)) {
                    console.log("Tried to load queryBoard, but some int failed to parse. x=%s, y=%s, score=%s, team=%s, groups=%s, reps=%s", xCount, yCount, score, team, groups, reps);
                    return null;
                }
                if (pawns == null) return null;
                if (pawns.length != xCount*yCount) return null;
                pawns = parseQueryLayout(xCount, yCount, pawns);

                return Board({
                    groupCount: groups,
                    repCount: reps,

                    goalScore: score,
                    goalTeam: team,

                    layout: pawns,
                    showNext: false,

                    position: {
                        x: -32,
                        y: -16
                    }
                });
            }

            function parseQueryLayout(xCount, yCount, layoutString){
                var layout = [];
                var parsedInt;
                for (var x = 0; x < xCount; x++) {
//                        layout.push([]);
                    for (var y = 0; y < yCount; y++) {
                        if (layout.length < yCount) layout.push([]);
                        parsedInt = parseInt(layoutString[y*xCount+x]);
                        if (parsedInt !== 0 && parsedInt !== 1) return null;
                        layout[y].push(parsedInt);
                    }
                }
                return layout;
            }

            start();
        </script>
    </body>
</html>
