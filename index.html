<!DOCTYPE html>
<html>
    <head>
        <title>District</title>
        <script src="http://code.jquery.com/jquery.min.js"></script>

        <link rel="icon" type="image/png" href="/favicon.png"/>
        <link rel="stylesheet" href="/css/main.css">
        <link rel="stylesheet" href="./css/district.css">

        <meta charset="utf-8">
    </head>
    <body>
        <div id="nav-container"></div>
        <script type="text/javascript">
        $(document).ready(function() {
        $('#nav-container').load('/nav.html');
        });
        </script>

        <div class="deck" id="deck">
        </div>

        <!--
        <div class="advance" id="advance" onclick="advance()">
            <a href="javascript:void(0)">Next...</a>
        </div>
        -->

        <script type="text/javascript">
            var slides = [];
            var puzzleSlides = [];
            var puzzleWindows = [];

            var slideIndex = 0;
            var slideTotal = slides.length;

            var chosenColor = -1;
            var invertPuzzles = false;

            createBasicSlide = function(spec){
                var deck = document.getElementById("deck");

                if (slideIndex > 0) {
                    var ruler = document.createElement('div');
                    ruler.className = "ruler";
                    deck.appendChild(ruler);
                    ruler.innerHTML = "<hr>";
                }

                var slide = document.createElement('div');
                slide.className = "slide";
                deck.appendChild(slide);

                var words = document.createElement('div');
                words.className = "words";
                slide.appendChild(words);

                var title = document.createElement('div');
                title.className = "title";
                title.innerHTML = spec.title;
                words.appendChild(title);

                var description = document.createElement('div');
                description.className = "description";
                description.innerHTML = spec.description;
                words.appendChild(description);

                slides.push(slide);
                slideIndex++;

                return {
                    slide,
                    words,
                    title,
                    description,
                }
            }

            appendChoiceSlide = function(spec){
                var deck = document.getElementById("deck");

                var {slide, words, title, description} = createBasicSlide(spec);

                var choice = document.createElement('div');
                choice.className = "choice";
                slide.appendChild(choice);

                var colorButton0 = document.createElement('div');
                colorButton0.className = "colorButton";
                colorButton0.style.backgroundColor = "red";
                choice.appendChild(colorButton0);

                var colorButton1 = document.createElement('div');
                colorButton1.className = "colorButton";
                colorButton1.style.backgroundColor = "blue";
                choice.appendChild(colorButton1);
                
                colorButton0.addEventListener("click", function(){
                    chooseColor(0, colorButton0, colorButton1);
                });
                colorButton1.addEventListener("click", function(){
                    chooseColor(1, colorButton0, colorButton1);
                });

                return slide;
            }

            appendInterventionSlide = function(spec){
                var deck = document.getElementById("deck");

                var {slide, words, title, description} = createBasicSlide(spec);

                var yinyang = document.createElement('div');
                yinyang.className = "yinyang";
                slide.appendChild(yinyang);
                yinyang.addEventListener("click", function(){
                    advance();
                });

                //yinyang.style.backgroundColor = ["red", "blue"][chosenColor];

                return slide;
            }

            appendPuzzleSlide = function(spec){
                var deck = document.getElementById("deck");

                var {slide, words, title, description} = createBasicSlide(spec);

                var puzzle = document.createElement('div');
                puzzle.className = "puzzle";
                slide.appendChild(puzzle);

                var embedURL = "./embed.html"+spec.query;
                puzzle.innerHTML = "<iframe id=\"frame\" src=\""+embedURL+"\" width=\"640px\" height=\"640px\" style=\"border:1px solid black\"></iframe>";

                var puzzleFrame = puzzle.querySelector("#frame");
                puzzleFrame.addEventListener('load', function(){
                    puzzleFrame.contentWindow.setCompletionCallback(advance);

                    puzzleSlides.push(slide);
                    puzzleWindows.push(puzzleFrame.contentWindow);

                    slide.addEventListener("mouseenter", function(event){
                        setActiveSlide(event.target);
                    });
                    slide.addEventListener("touchstart", function(event){
                        setActiveSlide(event.target);
                    });

                    if (invertPuzzles) puzzleFrame.contentWindow.invertBoard();
                    if (spec.muteGap == true) puzzleFrame.contentWindow.setDrawGap(false);
                    if (spec.muteReset == true) puzzleFrame.contentWindow.setShowReset(false);

                    setActiveSlide(slide);
                });

                return slide;
            }

            var slideSpecs = [
                {
                    generator: appendPuzzleSlide,
                    title: "Welcome to the Carpet Kingdom",
                    description:
                    "<p>Alice and Bob are opposing rulers of the Carpet Kingdom. Alice likes Red, but Bob likes Blue.</p><p>They split the floor into 2 separate carpet districts.</p><p>For now, everyone is happy.</p>",
                    query: "?=&x=2&y=1&s=-1&t=-1&g=2&r=1&p=01",
                    muteReset: true,
                    muteGap: true,
                },
                {
                    generator: appendPuzzleSlide,
                    title: "Democracy is Born",
                    description: "<p>Two new subjects move in, so Alice and Bob invent democracy and hold a vote for color.</p><p>Both districts tie, so they compromise on Grey.</p>",
                    query: "?=&x=2&y=2&s=-1&t=-1&g=2&r=1&p=0110",
                    muteReset: true,
                    muteGap: true,
                },
                {
                    generator: appendPuzzleSlide,
                    title: "The Kingdom Expands",
                    description: "<p>A third district is added to accomodate new arrivals, and another vote is held.</p><p>Most citizens are satisfied with the outcome.</p>",
                    query: "?=&x=2&y=3&s=-1&t=-1&g=3&r=1&p=001011",
                    muteReset: true,
                    muteGap: true,
                },
                {
                    generator: appendChoiceSlide,
                    title: "God gets Bored.",
                    description: "<p>The Almighty is frankly annoyed that everyone is getting along so well.</p><p>Our lord picks a color to win the next election, just to shake things up.</p>",
                },
                {
                    generator: appendPuzzleSlide,
                    title: "WINTEAM Carpeters Take Charge",
                    description: "<p>In a stunning turn of events, WINTEAM wins a supermajority of the floor.</p><p>This gives them the power to redraw the districts (they promise to be totally fair about it).<p>",
                    query: "?=&x=3&y=3&s=1&t=0&g=3&r=1&p=011010110",
                    muteGap: true,
                },
                {
                    generator: appendPuzzleSlide,
                    title: "Seeds of Discontent",
                    description: "<p>The kingdom is perfectly split on their preferred color.</p><p>Yet somehow, the floor is still mostly WINTEAM. Much of the LOSETEAM population feels like their <b>votes didn't count</b>.</p>",
                    query: "?=&x=4&y=3&s=2&t=0&g=4&r=1&p=000000111111",
                    muteGap: true,
                },
                {
                    generator: appendPuzzleSlide,
                    title: "Cracking & Packing",
                    description: "<p>The WINTEAM leadership starts grouping a large chunk of LOSETEAM voters into one district, a technique they dub <b>\"Packing\"</b>.</p><p>They dristribute the leftover LOSETEAM voters between guaranteed WINTEAM districts, and nickname this process <b>\"Cracking\"</b>.</p>",
                    query: "?=&x=5&y=3&s=1&t=0&g=3&r=1&p=001110011100111",
                    muteGap: true,
                },
                {
                    generator: appendPuzzleSlide,
                    title: "Linking",
                    description: "<p>WINTEAM neighborhoods start to fracture, making it hard to draw <b>compact districts</b> around them.</p><p>They will have to be a bit more crafty to maintain power.</p>",
                    query: "?=&x=6&y=3&s=1&t=0&g=3&r=1&p=001100011110110011",
                    muteGap: true,
                },
                {
                    generator: appendPuzzleSlide,
                    title: "God Becomes Concerned.",
                    description: "<p>Concerned about WINTEAM's disproportionate power, God starts tracking the difference between the <b>vote percentage</b> and <b>floor percentage</b> for each color.</p><p>\"I shall call this metric... the <b>Efficiency Gap</b>\" says God.</p><p>In the next election, God is shocked to find an Efficiency Gap of <b>27%</b>.</p>",
                    query: "?=&x=6&y=5&s=2&t=0&g=6&r=1&p=111000111000111111000111000111",
                },
                {
                    generator: appendPuzzleSlide,
                    title: "God Intervenes",
                    description: "<p>God checks out a library book on Voting Systems, and comes across a system called <b>Proportional Representation</b>.</p><p>God decides to try it, using <b>half as many districts</b> but <b>two winners each</b>.</p><p>The Efficiency Gap drops dramatically.</p>",
                    query: "?=&x=6&y=5&s=-1&t=-1&g=3&r=2&p=111000111000111111000111000111",
                },
                {
                    generator: appendPuzzleSlide ,
                    title: "All is Well",
                    description: "<p>God notices that <b>more representatives</b> means a <b>lower Efficiency Gap</b>.</p><p>Satisfied with this solution, God kicks back until the Carpet Kingdom is consumed by a civil war precipitated by their extremely polarizing Plurality-Rule voting system.</p>",
                    query: "?=&x=6&y=5&s=-1&t=-1&g=3&r=3&p=111000111000111111000111000111",
                },
                /*
                {
                    generator: appendInterventionSlide,
                    title: "God Intervenes... again.",
                    description: "<p>\"Hey wait a minute,\" says God,</p><p>\"This sucks. New rule: From now on, each district picks two colors. Put them in stripes on the floor or something.\"</p><p>WINTEAM is unfazed by the new rule. LOSETEAM is busy doodling images of balance.</p>",
                },
                {
                    generator: appendPuzzleSlide,
                    title: "Balance is Restored",
                    description: "<p>WINTEAM was not prepared for the consequences of electing multiple representatives.</p><p>They try their best to engineer the map in their favor, but ultimately LOSETEAM gains a roughly proportionate number of seats.</p>",
                    query: "?=&x=6&y=3&s=-1&t=0&g=3&r=2&p=001100011110110011",
                },
                */
            ];

            chooseColor = function(color, button0, button1){
                if (chosenColor < 0) {
                    chosenColor = color;

                    var colorNames = ["Red", "Blue"];
                    slideSpecs.forEach(function(spec){
                        var regexWin = /WINTEAM/g;
                        var regexLose = /LOSETEAM/g;
                        spec.title = spec.title.replace(regexWin, colorNames[chosenColor]);
                        spec.description = spec.description.replace(regexWin, colorNames[chosenColor]);

                        spec.title = spec.title.replace(regexLose, colorNames[1-chosenColor]);
                        spec.description = spec.description.replace(regexLose, colorNames[1-chosenColor]);
                    });

                    invertPuzzles = color == 1;
                    button0.onclick = null;
                    button1.onclick = null;
                    advance();
                }
            }

            setActiveSlide = function(targetSlide){
                for (var i = 0; i < puzzleSlides.length; i++) {
                    if (puzzleSlides[i] == targetSlide) puzzleWindows[i].setPause(false);
                    else puzzleWindows[i].setPause(true);
                }
            }

            advance = function(){
                if (slideSpecs.length > 0) {
                    var spec = slideSpecs.shift();
                    var slide = spec.generator(spec);

                    slide.scrollIntoView({
                        behavior: "smooth",
                        block: "start",
                    });
                    if (slideSpecs.length == 0) {
                        document.getElementById("advance").style.visibility = "hidden";
                    }
                }
            }

            advance();

        </script>

        <div id="footer-container"></div>
        <script type="text/javascript">
        $(document).ready(function() {
        $('#footer-container').load('/footer.html');
        });
        </script>
    </body>
</html>
