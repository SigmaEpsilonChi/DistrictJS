<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>District</title>
    <script language="javascript" src="./view.js" type="text/javascript"></script>
    <script language="javascript" src="./port.js" type="text/javascript"></script>
    <script language="javascript" src="./menu.js" type="text/javascript"></script>
    <script language="javascript" src="./post.js" type="text/javascript"></script>
    <script language="javascript" src="./pawn.js" type="text/javascript"></script>
    <script language="javascript" src="./fence.js" type="text/javascript"></script>
    <script language="javascript" src="./board.js" type="text/javascript"></script>
    <script language="javascript" src="./group.js" type="text/javascript"></script>
    <script language="javascript" src="./camera.js" type="text/javascript"></script>
    <script language="javascript" src="./button.js" type="text/javascript"></script>
    <script language="javascript" src="./counter.js" type="text/javascript"></script>
    <script language="javascript" src="./scorestack.js" type="text/javascript"></script>
    <script language="javascript" src="./scoreboard.js" type="text/javascript"></script>
  </head>
  <body>
    <canvas width="512" height="512" id="myCanvas">
            Canvas tag not supported
    </canvas>
    <script type='text/javascript'>
        var CANVAS_WIDTH = 512;
        var CANVAS_HEIGHT = 512;

        var canvas = document.getElementById("myCanvas");;
        var context = canvas.getContext("2d");

        canvas.addEventListener("mousedown", onMouseDown, false);
        canvas.addEventListener("mouseup", onMouseUp, false);
        canvas.addEventListener("mousemove", onMouseMove, false);

        var mouseListeners = [];
        var updateListeners = [];

        var textX = 50;
        var textY = 50;

        var sizes = {
            pawnRadius: 1,
            postRadius: .3,
            fenceWidth: .3,
            counterSize: .03,
            counterGap: .005,
        }

        var colors = {
            teamNeutral: '#808080',
            groupNeutral: 'rgba(128, 128, 128, 0.5)',

            teams: [
                '#A80C10',
                '#560CA8',
                '#0CA8A4',
            ],

            groups: [
                'rgba(224, 32, 32, 0.5)',
                'rgba(32, 32, 224, 0.5)',
                'rgba(32, 224, 32, 0.5)',
            ],

            post: {
                base: '#E6E6E6',
                touch: '#CCCCCC',
            },

            fence: {
                base: '#202020',
                drag: '#404040',
            },

            menu: {
                base: '#18F2F2',
                touch: '#F2BC18',
                click: '#CCCCCC'
            }
        }

        var borderSize = 4;

        var mousePoint = {
            x: 0,
            y: 0
        }

        var mousePointWorld = {
            x: 0,
            y: 0
        }

        var startFov = 12;

        var startPosition = {
            x: 0,
            y: -16
        }

        var puzzles = [
            {
                groupCount: 2,
                layout: [
                    [0, 1],
                ],
                position: {
                    x: 0,
                    y: 0,
                },
            },
            {
                groupCount: 2,
                layout: [
                    [0, 0],
                    [0, 1],
                ],
                position: {
                    x: 0,
                    y: 32,
                },
            },
            {
                groupCount: 2,
                layout: [
                    [0, 0],
                    [0, 1],
                    [1, 0],
                ],
                position: {
                    x: 32,
                    y: 32,
                },
            },
            {
                groupCount: 3,
                layout: [
                    [0, 0, 0],
                    [0, 1, 0],
                    [1, 0, 1],
                ],
                position: {
                    x: 32,
                    y: 64,
                },
            },
            {
                groupCount: 4,
                layout: [
                    [0, 0, 0],
                    [0, 1, 0],
                    [1, 0, 1],
                    [1, 1, 1],
                ],
                position: {
                    x: -32,
                    y: 96,
                },
            },
            {
                groupCount: 4,
                layout: [
                    [0, 0, 0, 0],
                    [0, 1, 0, 0],
                    [1, 0, 1, 1],
                    [1, 1, 1, 1],
                ],
                position: {
                    x: 0,
                    y: 96,
                },
            },
            {
                groupCount: 4,
                layout: [
                    [0, 0, 0, 0, 0],
                    [0, 1, 0, 0, 1],
                    [1, 0, 1, 1, 1],
                    [1, 1, 1, 1, 1],
                ],
                position: {
                    x: 32,
                    y: 128,
                },
            },
            {
                groupCount: 5,
                layout: [
                    [0, 0, 0, 0, 0],
                    [0, 1, 0, 0, 1],
                    [1, 0, 1, 1, 1],
                    [1, 1, 1, 1, 1],
                    [1, 1, 1, 1, 1],
                ],
                position: {
                    x: 64,
                    y: 96,
                },
            },
            {
                groupCount: 5,
                layout: [
                    [0, 0, 0, 0, 0],
                    [0, 1, 0, 0, 1],
                    [1, 0, 1, 1, 1],
                    [1, 1, 1, 1, 1],
                    [1, 1, 1, 1, 1],
                    [1, 1, 1, 1, 1],
                ],
                position: {
                    x: 96,
                    y: 96,
                },
            },
        ];

        var boards = [];
        var board = null;
        var camera;

        var time = 0;
        var deltaTime;

        var view = new View();
        var menu = new Menu();
        var port = new Port();

        function start() {
            var FPS = 60;
            deltaTime = 1/FPS;
            setInterval(function() {
              update();
              draw();
            }, 1000/FPS);

            for (var i = 0; i < puzzles.length; i++) {
                boards.push(new Board(puzzles[i]))
            }

            camera = new Camera();
            camera.position = startPosition;
            camera.fov = startFov;

            nextBoard();

            drawBorder();

            update();
            draw();
        }

        function update() {
            time = time+deltaTime;
            //camera.translate(Math.sin(time), 0);
            //camera.setZoom(2+Math.sin(time));
            menu.update();
            for (var i = 0; i < updateListeners.length; i++) {
                updateListeners[i].update();
            }
        }

        function draw() {
            clear();
            var visibleBoards = 0;
            for (var i = 0; i < boards.length; i++) {
                if (boards[i].isVisible()) {
                    boards[i].draw();
                    visibleBoards++;
                }
            }
            //console.log("Drawing "+visibleBoards+" of "+boards.length+" boards");
            //camera.report();
            //if (board != null) board.draw();
            menu.draw();
            drawBorder();
        }

        function nextBoard(){
            if (board == null) {
                board = boards[0];
            }
            else {
                board.setActive(false);

                var boardIndex = boards.indexOf(board)+1;
                if (boardIndex < boards.length) board = boards[boardIndex];
                else board = null;
            }
            
            if (board == null) camera.transitionTo(startPosition, startFov, completeTransition);
            else camera.transitionTo(board.position, board.fov, completeTransition);
        }

        function completeTransition(){
            if (board != null) board.setActive(true);
        }

        function clear(){
            //context.clearRect(borderSize, borderSize, CANVAS_WIDTH-borderSize*2, CANVAS_HEIGHT-borderSize*2);
            context.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        }

        function drawBorder(){
            context.beginPath();
            context.rect(borderSize/2, borderSize/2, CANVAS_WIDTH-borderSize, CANVAS_HEIGHT-borderSize);
            context.lineWidth = borderSize;
            context.strokeStyle = '#000000';
            context.stroke();
        }

        function onMouseDown(event){
            for (var i = 0; i < mouseListeners.length; i++) {
                mouseListeners[i].onMouseDown(event);
            }

            if (board != null) board.onMouseDown(mousePoint);

            draw();
        }

        function onMouseUp(event){
            for (var i = 0; i < mouseListeners.length; i++) {
                mouseListeners[i].onMouseUp(event);
            }

            if (board != null) board.onMouseUp(mousePoint);

            draw();
        }

        function onMouseMove(event){
            for (var i = 0; i < mouseListeners.length; i++) {
                mouseListeners[i].onMouseMove(event);
            }

            mousePoint = getMousePos(canvas, event);
            mousePointWorld = camera.transformPoint(mousePoint);

            if (board != null) board.onMouseMove(mousePoint);

            draw();
        }

        function getMousePos(canvas, event){
            var rect = canvas.getBoundingClientRect();
            return {
                x: event.clientX - rect.left,
                y: event.clientY - rect.top
            };
        }

        function clamp01(value){
            return Math.max(0, Math.min(value, 1));
        }

        function smooth01(value){
            return clamp01((1-Math.cos(value*Math.PI))/2);
        }

        function lerp(a, b, t){
            t = clamp01(t);
            return (1-t)*a+t*b;
        }

        function addPoints(a, b){
            return {
                x: a.x+b.x,
                y: a.y+b.y
            }
        }

        function lerpPoint(a, b, t){
            return {
                x: lerp(a.x, b.x, t),
                y: lerp(a.y, b.y, t)
            }
        }

        function smoothLerp(a, b, t){
            return lerp(a, b, smooth01(t));
        }

        function smoothLerpPoint(a, b, t){
            return lerpPoint(a, b, smooth01(t));
        }

        function tickProgress(flag, progress, duration){
            if (flag) progress += deltaTime/duration;
            else progress -= deltaTime/duration;
            return clamp01(progress);
        }

        function rgba(r, g, b, a){
            return "rgba("+[r, g, b, a]+")";
        }

        function va(v, a){
            return "rgba("+[v, v, v, a]+")";
        }

        function pointString(point){
            return "("+point.x+", "+point.y+")";
        }

        function xyString(x, y){
            return "("+x+", "+y+")";
        }

        function distance(a, b){
            return Math.sqrt((a.x-b.x)**2+(a.y-b.y)**2);
        }

        function manhattan(a, b){
            return Math.abs(a.x-b.x)+Math.abs(a.y-b.y);
        }

        start();
    </script>
  </body>
</html>
