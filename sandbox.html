<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>District</title>

        <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-98651852-1', 'auto');
        ga('send', 'pageview');
        </script>

        <meta property="og:title" content="District Sandbox">
        <meta property="og:description" content="Level Editor for District, a Game about Representation and Redistricting.">
        <meta property="og:image" content="http://polytrope.com/district/res/thumbnail.png">
        <meta property="og:url" content="http://polytrope.com/district/sandbox.html">
        <meta property="twitter:card" content="summary_large_image">

        <script src="http://code.jquery.com/jquery.min.js"></script>
        <link rel="icon" type="image/png" href="/favicon.png"/>
        <link rel="stylesheet" href="./css/sandbox.css">

    </head>
    <body>
        <div id="nav-container"></div>
        <script type="text/javascript">
        $(document).ready(function() {
        $('#nav-container').load('/nav.html');
        });
        </script>

        <div class="page">
            <div class="title">DISTRICT</div>

            <div class="sandbox">

                <div id="district"></div>

                <div class="openContainer">
                    <div class="openButton" onclick="openToolbox();">&#9776;</div>
                </div>

                <div class="tools" id="toolbox">
                    <div class="container">
                        <div class="close" onclick="closeToolbox();">&#x2716;</div>

                        <div class="quantity">
                            <div class="button" onclick="subtractRow();">&#10134;</div>
                            <div class="button" onclick="addRow();">&#10133;</div>
                            <div class="number" id="rowCounter">4 Rows</div>
                        </div>

                        <div class="spacer"></div>

                        <div class="quantity">
                            <div class="button" onclick="subtractColumn();">&#10134;</div>
                            <div class="button" onclick="addColumn();">&#10133;</div>
                            <div class="number" id="columnCounter">6 Columns</div>
                        </div>

                        <div class="spacer"></div>
                        <hr>
                        <div class="spacer"></div>

                        <div class="quantity">
                            <div class="button" onclick="scoreDown();">&#10134;</div>
                            <div class="button" onclick="scoreUp();">&#10133;</div>
                            <div class="button" id="scoreCounter" onclick="switchTeam();">0</div>
                        </div>

                        <div class="spacer"></div>

                        <div class="quantity">
                            <div class="button" onclick="subtractGroup();">&#10134;</div>
                            <div class="button" onclick="addGroup();">&#10133;</div>
                            <div class="number" id="groupCounter">0 Groups</div>
                        </div>

                        <div class="spacer"></div>

                        <div class="quantity">
                            <div class="button" onclick="subtractRep();">&#10134;</div>
                            <div class="button" onclick="addRep();">&#10133;</div>
                            <div class="number" id="repCounter">0 Reps</div>
                        </div>

                        <div class="spacer"></div>
                        <hr>
                        <div class="spacer"></div>

                        <div class="url">
                            <input class="field" id="linkField" type="text" readonly="true" onClick="this.select();" value="link...">
                            <div class="name">Link:</div>
                        </div>

                        <div class="spacer"></div>
                        
                        <div class="url">
                            <input class="field" id="embedField" type="text" readonly="true" onClick="this.select();" value="embed...">
                            <div class="name">Embed:</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="redirect">
                <a href="http://polytrope.com/district/">Haven't played the original game yet? Click here!</a>
            </div>

        </div>
        <script type="text/javascript">
            var editing = false;
            toggleToolbox = function(){
                if (editing) closeToolbox();
                else openToolbox();
            }
            closeToolbox = function(){
                editing = false;
                var toolbox = document.getElementById('toolbox');
                toolbox.style.width = 0;
                toolbox.style.marginLeft = 0;

                if (board != null) {
                    board.setMutable(false);
                }
            }
            openToolbox = function(){
                editing = true;
                var toolbox = document.getElementById('toolbox');
                toolbox.style.width = "280px";
                toolbox.style.marginLeft = "16px";

                if (board != null) {
                    board.setMutable(true);
                }
            }

            var board = null;
            var embedWindow = null;

            var rowCounter = document.getElementById('rowCounter');
            var columnCounter = document.getElementById('columnCounter');
            var scoreCounter = document.getElementById('scoreCounter');
            var groupCounter = document.getElementById('groupCounter');
            var repCounter = document.getElementById('repCounter');

            var linkField = document.getElementById('linkField');
            var embedField = document.getElementById('embedField');

            addRow = function(){
                console.log("Sandbox: Adding Row");
                if (board != null) {
                    board.addRow();
                    refreshToolbox();
                }
            }
            subtractRow = function(){
                console.log("Sandbox: Subtracting Row");
                if (board != null) {
                    board.subtractRow();
                    refreshToolbox();
                }
            }
            addColumn = function(){
                console.log("Sandbox: Adding Column");
                if (board != null) {
                    board.addColumn();
                    refreshToolbox();
                }
            }
            subtractColumn = function(){
                console.log("Sandbox: Subtracting Column");
                if (board != null) {
                    board.subtractColumn();
                    refreshToolbox();
                }
            }
            scoreDown = function(){
                console.log("Sandbox: Score Down");
                if (board != null) {
                    board.scoreDown();
                    refreshToolbox();
                }
            }
            scoreUp = function(){
                console.log("Sandbox: Score Up");
                if (board != null) {
                    board.scoreUp();
                    refreshToolbox();
                }
            }
            switchTeam = function(){
                console.log("Sandbox: Switch Team");
                if (board != null) {
                    board.switchTeam();
                    refreshToolbox();
                }
            }
            addGroup = function(){
                console.log("Sandbox: Add Group");
                if (board != null) {
                    board.addGroup();
                    refreshToolbox();
                }
            }
            subtractGroup = function(){
                console.log("Sandbox: Subtract Group");
                if (board != null) {
                    board.subtractGroup();
                    refreshToolbox();
                }
            }
            addRep = function(){
                console.log("Sandbox: Add Rep");
                if (board != null) {
                    board.addRep();
                    refreshToolbox();
                }
            }
            subtractRep = function(){
                console.log("Sandbox: Subtract Rep");
                if (board != null) {
                    board.subtractRep();
                    refreshToolbox();
                }
            }

            refreshToolbox = function(){
                console.log("Refreshing Sandbox Toolbox");

                rowCounter.innerHTML = board.dimensions.y+" Rows";
                columnCounter.innerHTML = board.dimensions.x+" Columns";

                var goalScore = board.getGoalScore();

                var goalTeam = board.getGoalTeam();
                if (goalTeam < 0) {
                    scoreCounter.innerHTML = "&ndash;";
                    scoreCounter.style.backgroundColor = "gray";
                }
                else {
                    scoreCounter.innerHTML = (goalScore > 0 ? "+"+goalScore : goalScore);
                    if (goalTeam == 0) scoreCounter.style.backgroundColor = "red";
                    if (goalTeam == 1) scoreCounter.style.backgroundColor = "blue";
                }

                var groupCount = board.getGroupCount();
                groupCounter.innerHTML = groupCount+" Group"+(groupCount == 1 ? "" : "s");

                var repCount = board.getRepCount();
                repCounter.innerHTML = repCount+" Rep"+(repCount == 1 ? "" : "s");

                var url = window.location.href;
                if (url.includes("?")) url = url.slice(0, url.indexOf("?"));
                url += board.getQueryString();
                linkField.value = url;

                window.history.replaceState({}, "District | Sandbox", url);

                var url = embedWindow.location.href;
                if (url.includes("?")) url = url.slice(0, url.indexOf("?"));
                url += board.getQueryString();
                embedField.value = "<embed src=\""+url+"\" width=\"640px\" height=\"640px\" style=\"border:1px solid black\"></embed>";
            }
        </script>

        <script type="text/javascript">
            var game = document.getElementById('district');
            var url = window.location.href;
            var query = url.split('?')[1];
            if (query == undefined) query = "";
            else query = "?"+query;

            var embedURL = "./embed.html"+query;
            game.innerHTML = "<iframe id=\"frame\" src=\""+embedURL+"\" width=\"640px\" height=\"640px\" style=\"border:1px solid black\"></iframe>";


            var frame = game.querySelector("#frame");
            frame.addEventListener('load', function(){
                console.log("FRAME LOADED - Fetching board");
                embedWindow = frame.contentWindow;
                board = frame.contentWindow.getBoard();
                board.setRefreshQueryCallback(refreshToolbox);
                refreshToolbox();
                if (!window.location.href.includes('?')) openToolbox();
            });
        </script>

        <div id="footer-container"></div>
        <script type="text/javascript">
        $(document).ready(function() {
        $('#footer-container').load('/footer.html');
        });
        </script>
    </body>
</html>
