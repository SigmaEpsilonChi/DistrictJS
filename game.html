<!DOCTYPE html>
<style>
html{
    width:100%;
    height:100%;
    margin: 0;
    padding: 0;
}
body{
    width:100%;
    height:100%;
    background-color:#FFFFFF;
    overflow: hidden;
    margin: 0;
    padding: 0;
}
canvas {
    display: block;
    touch-action: none;
}
</style>
    <html>
    <head>
        <title>District</title>
        <script language="javascript" src="./js/view.js" type="text/javascript"></script>
        <script language="javascript" src="./js/port.js" type="text/javascript"></script>
        <script language="javascript" src="./js/menu.js" type="text/javascript"></script>
        <script language="javascript" src="./js/post.js" type="text/javascript"></script>
        <script language="javascript" src="./js/pawn.js" type="text/javascript"></script>
        <script language="javascript" src="./js/fence.js" type="text/javascript"></script>
        <script language="javascript" src="./js/board.js" type="text/javascript"></script>
        <script language="javascript" src="./js/group.js" type="text/javascript"></script>
        <script language="javascript" src="./js/stage.js" type="text/javascript"></script>
        <script language="javascript" src="./js/camera.js" type="text/javascript"></script>
        <script language="javascript" src="./js/button.js" type="text/javascript"></script>
        <script language="javascript" src="./js/counter.js" type="text/javascript"></script>
        <script language="javascript" src="./js/balance.js" type="text/javascript"></script>

        <link rel="icon" type="image/png" href="/favicon.png"/>
    </head>
    <body>
        <canvas width="768" height="768" id="gameCanvas">Canvas tag not supported</canvas>
        <img id="baddistricts" width="0" height="0" src="./res/baddistricts.png">

        <script type='text/javascript'>
            var endStageImage = document.getElementById("baddistricts");

            var canvas = document.getElementById("gameCanvas");;
            var context = canvas.getContext("2d");

            var CANVAS_WIDTH = canvas.offsetWidth;
            var CANVAS_HEIGHT = canvas.offsetHeight;

            canvas.addEventListener("mousedown", onMouseDown, false);
            canvas.addEventListener("mouseup", onMouseUp, false);
            canvas.addEventListener("mousemove", onMouseMove, false);

            canvas.addEventListener("touchstart", onTouchStart, false);
            canvas.addEventListener("touchend", onTouchEnd, false);
            canvas.addEventListener("touchcancel", onTouchCancel, false);
            canvas.addEventListener("touchmove", onTouchMove, false);

            var mouseListeners = [];
            var updateListeners = [];

            var textX = 50;
            var textY = 50;

            var sizes = {
                pawnRadius: 1,
                postRadius: .3,
                fenceWidth: .3,
                counterSize: .025,
                counterGap: .005,
            }

            var colors = {
                teamNeutral: '#808080',
                groupNeutral: 'rgb(192, 192, 192)',

                teams: [
                    'rgb(208, 32, 32)',
                    'rgb(32, 32, 208)',
                    'rgb(32, 208, 32)',
                ],

                teamsLight: [
                    'rgb(224, 128, 128)',
                    'rgb(128, 128, 224)',
                    'rgb(128, 224, 128)',
                ],

                teamsDark: [
                    'rgb(192, 16, 16)',
                    'rgb(16, 16, 192)',
                    'rgb(16, 192, 16)',
                ],

                post: {
                    base: '#E6E6E6',
                    touch: '#CCCCCC',
                },

                fence: {
                    base: '#202020',
                    drag: '#606060',
                },

                menu: {
                    base: '#18F2F2',
                    touch: '#F2BC18',
                    click: '#CCCCCC',
                    prompt: '#404040'
                },

                balance: {
                    arm: '#404040',
                    pan: '#202020',
                }
            }

            var strings = {
                center: "center",
            }

            var borderSize = 1;

            var mousePoint = {
                x: 0,
                y: 0
            }

            var mousePointWorld = {
                x: 0,
                y: 0
            }

            var startFov = 12;

            var startPosition = {
                x: 0,
                y: -16
            }

            var puzzles = [
                {
                    groupCount: 2,
                    showReset: false,
                    layout: [
                        [0, 1],
                    ],
                },
                {
                    groupCount: 2,
                    showReset: false,
                    layout: [
                        [1, 0],
                        [0, 1],
                    ],
                },
                {
                    groupCount: 3,
                    showReset: false,
                    layout: [
                        [0, 0],
                        [0, 1],
                        [1, 1],
                    ],
                },
                {
                    goalScore: 1,
                    secondScore: 1,
                    groupCount: 3,
                    layout: [
                        [0, 1, 1],
                        [0, 1, 0],
                        [1, 1, 0],
                    ],
                },
                {
                    goalScore: 2,
                    secondScore: 2,
                    groupCount: 4,
                    layout: [
                        [0, 0, 0, 0],
                        [0, 0, 1, 1],
                        [1, 1, 1, 1],
                    ],
                },
                {
                    goalScore: 1,
                    secondScore: 1,
                    groupCount: 4,
                    layout: [
                        [0, 0, 0, 0],
                        [0, 0, 0, 0],
                        [1, 1, 1, 1],
                        [1, 1, 1, 1],
                    ],
                },
                {
                    goalScore: 1,
                    secondScore: 3,
                    groupCount: 3,
                    layout: [
                        [0, 0, 1, 1, 1],
                        [0, 0, 1, 1, 1],
                        [0, 0, 1, 1, 1],
                    ],
                },
                {
                    goalScore: 1,
                    secondScore: 2,
                    groupCount: 3,
                    layout: [
                        [0, 0, 1, 1, 0, 0],
                        [0, 1, 1, 1, 1, 0],
                        [1, 1, 0, 0, 1, 1],
                    ],
                },
                {
                    goalScore: 2,
                    secondScore: 4,
                    groupCount: 4,
                    layout: [
                        [0, 1, 1, 1, 0, 0],
                        [0, 1, 1, 1, 0, 0],
                        [0, 1, 1, 1, 1, 1],
                        [0, 1, 1, 1, 1, 1],
                        [0, 1, 1, 1, 1, 1],
                        [0, 0, 0, 0, 0, 0],
                    ],
                },
            ];

            var puzzlePositions = [
                {x: 0, y: 0},
                {x: 0, y: 32},
                {x: -32, y: 32},
                {x: 0, y: 64},
                {x: 32, y: 96},
                {x: 0, y: 128},
                {x: 32, y: 128},
                {x: 64, y: 128},
                {x: 64, y: 96},
                {x: 96, y: 32},
                {x: 96, y: 64},
                {x: 128, y: 64},
            ];

            var stages = [];
            var stage = null;
            var stageIndex = 0;

            var boards = [];

            for (var i = 0; i < puzzles.length; i++) {
                puzzles[i].position = puzzlePositions[i];
            }

            var sandboxStage = new SandboxStage();
            var openingStage = new OpeningStage();
            var choiceStage = new ChoiceStage();
            var endStage = new EndStage();

            stages.push(openingStage);

            for (var i = 0; i < puzzles.length; i++) {
                boards.push(new Board(puzzles[i]))
                stages.push(boards[i]);
            }

            var choiceStageIndex = stages.indexOf(boards[3]);
            stages.splice(choiceStageIndex, 0, choiceStage);
            stages.push(endStage);
            stages.push(sandboxStage);

            var time = 0;
            var deltaTime;
            var drawTime = 0;

            var playerTeam = -1;

            var click = false;
            var dirty = false;

            var camera = new Camera();
            var view = new View();
            var menu = new Menu();
            var port = new Port();

            function start() {
                var FPS = 60;
                deltaTime = 1/FPS;
                setInterval(function() {
                  update();
                }, 1000/FPS);

                stage = stages[0];

                var sandboxString = "?=sandbox";
                var url = window.location.href;
                var slice = url.slice(url.length-sandboxString.length);
                if (slice == sandboxString) {
                    stage = sandboxStage;
                }
                else {
                    var queryBoard = getQueryBoard();
                    if (queryBoard != null) {
                        console.log("Adding queryBoard to stages");
                        stages.unshift(queryBoard);
                        stage = queryBoard;
                    }
                }

                stageIndex = stages.indexOf(stage);
                stage.setActive(true);



                camera.position = stage.position;
                camera.fov = stage.fov;

                update();

                window.requestAnimationFrame(step);

            }

            function step(timestamp) {
                if (dirty) {
                    draw();
                    dirty = false;
                }
                window.requestAnimationFrame(step);
            }

            function update() {
                time = time+deltaTime;
                menu.update();
                for (var i = 0; i < updateListeners.length; i++) {
                    updateListeners[i].update();
                }
                for (var i = 0; i < stages.length; i++) {
                    if (camera.isVisible(stages[i].position, stages[i].size)) {
                        stages[i].update();
                    }
                }
                dirty = true;
            }

            function draw() {
                clear();
                for (var i = 0; i < stages.length; i++) {
                    if (camera.isVisible(stages[i].position, stages[i].size)) {
                        stages[i].draw();
                    }
                }
                menu.draw();
                //drawBorder();
            }

            function nextStage(){
                stage.setActive(false);

                stageIndex = (stageIndex+1)%stages.length;
                stage = stages[stageIndex];

                camera.transitionTo(stage.position, stage.fov, completeTransition);
            }

            function setStageIndex(index){
                stage.setActive(false);

                stageIndex = index;
                stage = stages[stageIndex];

                camera.transitionTo(stage.position, stage.fov, completeTransition);
            }

            function completeTransition(){
                if (stage != null) stage.setActive(true);
            }

            function clear(){
                //context.clearRect(borderSize, borderSize, CANVAS_WIDTH-borderSize*2, CANVAS_HEIGHT-borderSize*2);
                context.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            }

            function drawBorder(){
                context.beginPath();
                context.rect(borderSize/2, borderSize/2, CANVAS_WIDTH-borderSize, CANVAS_HEIGHT-borderSize);
                context.lineWidth = borderSize;
                context.strokeStyle = '#000000';
                context.stroke();
            }

            function roundTwo(){
                console.log("Starting round two");

                for (var i = 0; i < boards.length; i++) {
                    boards[i].switchScores();
                }
            }

            function onMouseDown(event){
                click = true;

                mousePoint = getMousePos(canvas, event);
                mousePointWorld = camera.transformPoint(mousePoint);

                for (var i = 0; i < mouseListeners.length; i++) {
                    mouseListeners[i].onMouseDown(mousePoint);
                }

                stage.onMouseDown(mousePoint);
            }

            function onMouseUp(event){
                click = false;

                for (var i = 0; i < mouseListeners.length; i++) {
                    mouseListeners[i].onMouseUp(mousePoint);
                }

                stage.onMouseUp(mousePoint);
            }

            function onMouseMove(event){
                mousePoint = getMousePos(canvas, event);
                mousePointWorld = camera.transformPoint(mousePoint);

                for (var i = 0; i < mouseListeners.length; i++) {
                    mouseListeners[i].onMouseMove(mousePoint);
                }

                stage.onMouseMove(mousePoint);
            }

            function onTouchStart(event){
                var touch = event.touches[0];
                var mouseEvent = new MouseEvent("mousedown", {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
                //onMouseDown(convertTouches(event));
            }

            function onTouchEnd(event){
                var touch = event.touches[0];
                var mouseEvent = new MouseEvent("mouseup");
                canvas.dispatchEvent(mouseEvent);
                //onMouseUp(convertTouches(event));
            }

            function onTouchMove(event){
                var touch = event.touches[0];
                var mouseEvent = new MouseEvent("mousemove", {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
                //onMouseMove(convertTouches(event));
            }

            function onTouchCancel(event){
                //onMouseUp(convertTouches(event));
            }

            function getMousePos(canvas, event){
                var rect = canvas.getBoundingClientRect();
                return {
                    x: event.clientX - rect.left,
                    y: event.clientY - rect.top
                };
            }

            function convertTouches(event){
                var touches = event.touches;
                if (touches.length > 0) {
                    event.clientX = touches[0].clientX;
                    event.clientY = touches[0].clientY;
                }
            }

            function getQueryString(field, url){
                var href = url ? url : window.location.href;
                var reg = new RegExp( '[?&]' + field + '=([^&#]*)', 'i' );
                var string = reg.exec(href);
                return string ? string[1] : null;
            }

            function getQueryBoard(){
                var xCount = parseInt(getQueryString("x"));
                var yCount = parseInt(getQueryString("y"));
                
                var score = parseInt(getQueryString("s"));
                var team = parseInt(getQueryString("t"));

                var groups = parseInt(getQueryString("g"));
                var pawns = getQueryString("p");

                if (isNaN(xCount) || isNaN(yCount) || isNaN(score) || isNaN(team) || isNaN(groups)) return null;

                if (pawns == null) return null;
                if (pawns.length != xCount*yCount) return null;
                pawns = parseQueryLayout(xCount, yCount, pawns);

                return new Board({
                    groupCount: groups,
                    goalScore: score,
                    goalTeam: team,
                    layout: pawns,
                    showNext: false,
                    position: {
                        x: -32,
                        y: -16
                    }
                });
            }

            function parseQueryLayout(xCount, yCount, layoutString){
                var layout = [];
                var parsedInt;
                for (var x = 0; x < xCount; x++) {
//                        layout.push([]);
                    for (var y = 0; y < yCount; y++) {
                        if (layout.length < yCount) layout.push([]);
                        parsedInt = parseInt(layoutString[y*xCount+x]);
                        if (parsedInt !== 0 && parsedInt !== 1) return null;
                        layout[y].push(parsedInt);
                    }
                }
                /*
                var pawn;
                for (var x = 0; x < this.xSize; x++) {
                    this.pawns.push([]);
                    for (var y = 0; y < this.ySize; y++) {
                        this.teamCount = Math.max(layout[y][x]+1, this.teamCount);

                        pawn = new Pawn(this, x, y, layout[y][x]);

                        this.pawns[x].push(pawn);
                        this.pawnList.push(pawn);
                    }
                }
                */
                return layout;
            }

            function clamp01(value){
                return Math.max(0, Math.min(value, 1));
            }

            function smooth01(value){
                return clamp01((1-Math.cos(value*Math.PI))/2);
            }

            function lerp(a, b, t){
                t = clamp01(t);
                return (1-t)*a+t*b;
            }

            function unlerp(a, b, t){
                t = clamp01(t);
                return (t-a)/(b-a);
            }

            function addPoints(a, b){
                return {
                    x: a.x+b.x,
                    y: a.y+b.y
                }
            }

            function subtractPoints(a, b){
                return {
                    x: a.x-b.x,
                    y: a.y-b.y
                }
            }

            function rotatePoint(p, a){
                return {
                    x: p.x*Math.cos(a)+p.y*-Math.sin(a),
                    y: p.x*Math.sin(a)+p.y*Math.cos(a)
                }
            }

            function rotateAround(p, c, a){
                return addPoints(rotatePoint(subtractPoints(p, c), a), c);
            }

            function lerpPoint(a, b, t){
                return {
                    x: lerp(a.x, b.x, t),
                    y: lerp(a.y, b.y, t)
                }
            }

            function smoothLerp(a, b, t){
                return lerp(a, b, smooth01(t));
            }

            function smoothLerpPoint(a, b, t){
                return lerpPoint(a, b, smooth01(t));
            }

            function tickProgress(flag, progress, duration){
                if (flag) progress += deltaTime/duration;
                else progress -= deltaTime/duration;
                return clamp01(progress);
            }

            function rgba(r, g, b, a){
                return "rgba("+[r, g, b, a]+")";
            }

            function va(v, a){
                //return "rgba("+v+", "+v+", "+v+", "+a+")";
                return "rgba("+[v, v, v, a]+")";
            }

            function pointString(point){
                return "("+point.x+", "+point.y+")";
            }

            function xyString(x, y){
                return "("+x+", "+y+")";
            }

            function distance(a, b){
                return Math.sqrt((a.x-b.x)**2+(a.y-b.y)**2);
            }

            function manhattan(a, b){
                return Math.abs(a.x-b.x)+Math.abs(a.y-b.y);
            }

            start();
        </script>
    </body>
</html>
